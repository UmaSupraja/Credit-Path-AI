            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                loginMessage.classList.add('hidden');
                loginError.classList.add('hidden');
                
                if (!loginForm.checkValidity()) {
                    showModal('Please enter a valid email and password.');
                    return;
                }

                const email = emailInput.value;
                const password = passwordInput.value;

                try {
                    const response = await fetch(loginApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, password: password })
                    });

                    if (response.ok) {
                        // --- SUCCESS ---
                        welcomeEmail.textContent = `Welcome, ${email}!`;
                        showPage('calculator-page');
                        loginForm.reset();
                        resultContainer.classList.add('hidden');
                        resultPlaceholder.classList.remove('hidden');
                    } else {
                        // --- FAILURE ---
                        const errorData = await response.json().catch(() => ({}));
                        let detail = errorData.detail || 'Login failed. Please try again.';
                        
                        // Handle Vercel's "Not Found" error specifically
                        if (response.status === 404) {
                            detail = "API endpoint not found. (404)";
                        }

                        loginError.textContent = detail;
                        loginError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    loginError.textContent = 'Could not connect to the server. Please try again later.';
                    loginError.classList.remove('hidden');
                }
            });
            
            createAccountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                createError.classList.add('hidden');

                const email = newEmailInput.value;
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (!createAccountForm.checkValidity()) {
                     showModal('Please fill out all fields.');
                     return;
                }
                if (newPassword !== confirmPassword) {
                    showModal('Passwords do not match. Please try again.');
                    return;
                }

                try {
                    const response = await fetch(createApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, password: newPassword })
                    });

                    if (response.ok) {
                        // --- SUCCESS ---
                        createAccountForm.reset();
                        showPage('login-page');
                        loginError.classList.add('hidden');
                        loginMessage.textContent = 'Account created successfully! Please sign in.';
                        loginMessage.classList.remove('hidden');
                    } else {
                        // --- FAILURE ---
                        const errorData = await response.json().catch(() => ({}));
                        let detail = errorData.detail || 'Could not create account.';
                        
                        // Handle Vercel's "Not Found" error specifically
                        if (response.status === 404) {
                            detail = "API endpoint not found. (404)";
                        }

                        createError.textContent = detail;
                        createError.classList.remove('hidden');
                    }

                } catch (error) {
                    console.error("Create account error:", error);
                    createError.textContent = 'Could not connect to the server. Please try again later.';
                    createError.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', () => {
                showPage('login-page');
                calculatorForm.reset();
                closeChat();
                loginMessage.classList.add('hidden');
                loginError.classList.add('hidden');
            });
            
            goToCreateAccountBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginError.classList.add('hidden');
                loginMessage.classList.add('hidden');
                showPage('create-account-page');
            });

            goToLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                createError.classList.add('hidden');
                showPage('login-page');
            });
            
            closeModalBtn.addEventListener('click', hideModal);

            // --- Calculator Logic (Remains the same) ---

            calculatorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!calculatorForm.checkValidity()) {
                    calculatorForm.reportValidity();
                    showModal('Please fill out all 8 fields to calculate your risk.');
                    return;
                }

                setLoading(true);

                const formData = new FormData(calculatorForm);
                const data = {
                    homeOwn: formData.get('homeOwn'),
                    annualIncome: parseFloat(formData.get('annualIncome')),
                    yearsInCo: parseInt(formData.get('yearsInCo')),
                    yearsOfCredit: parseInt(formData.get('yearsOfCredit')),
                    loanPurpose: formData.get('loanPurpose'),
                    loanTerm: formData.get('loanTerm'),
                    monthlyDt: parseFloat(formData.get('monthlyDt')),
                    creditSc: parseInt(formData.get('creditSc')),
                };

                const apiPayload = {
                    instances: [data]
                };

                try {
                    const response = await fetch(calcApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(apiPayload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let detail = errorData.detail || 'API request failed.';
                        if (response.status === 404) {
                            detail = "API endpoint not found. (404)";
                        }
                        throw new Error(detail);
                    }
                    
                    const resultData = await response.json();
                    
                    if (resultData.predictions && resultData.predictions.length > 0) {
                        const result = resultData.predictions[0];
                        displayResult(result);
                    } else {
                        throw new Error("API returned no predictions.");
                    }

                } catch (error) {
                    console.error("Error calling backend API:", error);
                    showModal(`Error calculating risk: ${error.message}. Is the backend server running?`);
                } finally {
                    setLoading(false);
                }
            });

            const setLoading = (isLoading) => {
                if (isLoading) {
                    calcSubmitText.textContent = "Calculating...";
                    calcSubmitIcon.classList.add('hidden');
                    calcLoadingSpinner.classList.remove('hidden');
                    calculateBtn.disabled = true;
                } else {
                    calcSubmitText.textContent = "Calculate My Risk";
                    calcSubmitIcon.classList.remove('hidden');
                    calcLoadingSpinner.classList.add('hidden');
                    calculateBtn.disabled = false;
                }
            };

            const displayResult = (result) => {
                let borderColor, textColor, riskIcon;

                if (result.risk_level === "High Risk") {
                    borderColor = 'border-red-500';
                    textColor = 'text-red-300';
                    riskIcon = `<svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                } else if (result.risk_level === "Medium Risk") {
                    borderColor = 'border-yellow-500';
                    textColor = 'text-yellow-300';
                    // Fixed SVG xmlns and path
                    riskIcon = `<svg class="w-16 h-16 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
                } else { // Low Risk
                    borderColor = 'border-green-500';
                    textColor = 'text-green-300';
                    riskIcon = `<svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                }

                resultContainer.innerHTML = `
                    <div class="text-center p-4">
                        <div class="mx-auto mb-4">
                            ${riskIcon}
                        </div>
                        <h3 class="text-3xl font-bold ${textColor} mb-2">${result.risk_level}</h3>
                        <p class="text-xl text-white font-semibold mb-4">
                            Default Probability: ${(result.probability * 100).toFixed(1)}%
                        </p>
                        <div class="bg-slate-700 p-4 rounded-lg">
                            <p class="text-sm text-slate-300 font-medium">Recommended Action:</p>
                            <p class="text-base text-white">${result.recommended_action}</p>
                        </div>
                        <p class="text-xs text-slate-500 mt-6">This is a demo assessment. Do not use for real financial decisions.</p>
                    </div>
                `;
                
                resultContainer.classList.remove('hidden');
                resultContainer.classList.add(borderColor);
                resultPlaceholder.classList.add('hidden');
            };

            // --- AI CHAT LOGIC (Proxy to /api/chat) ---
            // NOTE: Do NOT place your API keys in frontend code. Implement a server-side
            // endpoint /api/chat that accepts { prompt } and uses your secret key to call the LLM.
            // The server should return JSON: { reply: "assistant answer text" }.

            const openChat = () => {
                chatModal.classList.remove('hidden');
            };

            const closeChat = () => {
                chatModal.classList.add('hidden');
            };
            
            const addChatMessage = (sender, message) => {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', sender);
                bubble.textContent = message;
                chatHistory.appendChild(bubble);
                // Scroll to bottom
                chatHistory.scrollTop = chatHistory.scrollHeight;
            };

            const handleChatSend = async () => {
                const prompt = chatInput.value.trim();
                if (!prompt) return;

                addChatMessage('user', prompt);
                chatInput.value = '';
                chatLoading.classList.remove('hidden');
                sendChatBtn.disabled = true;

                try {
                    const botResponse = await callGeminiApi(prompt);
                    addChatMessage('bot', botResponse);
                } catch (error) {
                    console.error("Error calling chat proxy:", error);
                    addChatMessage('bot', "Sorry, I'm having trouble connecting right now. Please try again later.");
                } finally {
                    chatLoading.classList.add('hidden');
                    sendChatBtn.disabled = false;
                    chatInput.focus();
                }
            };

            // Client now calls server proxy at chatApiUrl.
            // Expected request: POST { prompt: "<user text>" }
            // Expected response: { reply: "<assistant text>" }
            const callGeminiApi = async (prompt) => {
                const payload = { prompt };

                try {
                    const res = await fetch(chatApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        const message = err.error?.message || err.detail || `Chat API failed (${res.status})`;
                        throw new Error(message);
                    }

                    const json = await res.json();
                    // Expecting { reply: "..." }
                    if (json && (json.reply || json.result || json.answer)) {
                        // support a few response shapes
                        return json.reply ?? json.result ?? json.answer;
                    } else {
                        throw new Error("Chat API returned unexpected response shape.");
                    }
                } catch (e) {
                    throw e;
                }
            };

            // --- AI Chat Event Listeners ---
            chatBtn.addEventListener('click', openChat);
            closeChatBtn.addEventListener('click', closeChat);
            sendChatBtn.addEventListener('click', handleChatSend);
            // Allow sending with the "Enter" key
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatSend();
                }
            });

            // Set initial state (show login page)
            showPage('login-page');
        });
